<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Search 検索</title>
		<style> body{ font-family: "メイリオ", Meiryo,
					"ＭＳ Ｐゴシック", "MS PGothic", sans-serif;
				font-size: 16px; line-height: 1.5; } </style>
		<script>
		if (window.module) delete module;
		</script>
	</head>
	<body>
		<h3>Search 検索</h3>

		<script src="mithril.min.js" ></script>
		<div id="$div" />
		<script>
		void function () {
			'use strict';

			// text
			const text = m.prop('');
			let logs = [];
			let wholeObject = {};

			// view
			function view() {
				return [m('form', {onsubmit: search},
						m('input', m_on('change', 'value', text,
							{autofocus: true, placeholder: '入力', size: 100})),
						m('button[type=submit]', {onclick: search}, '検索')),
					m('hr'),
					myViewResult()];
			}

			// 結果
			function myViewResult() {
				return m('pre', logs.join('\n'));
			}

			// HTML要素のイベントと値にプロパティを接続するユーティリティ
			function m_on(eventName, propName, propFunc, attrs) {
				attrs = attrs || {};
				attrs['on' + eventName] = m.withAttr(propName, propFunc);
				attrs[propName] = propFunc();
				return attrs;
			}

			m.mount($div, {view});

			function progressCallback(file, object) {
				//console.log(file);
				logs.push(file);
				logs = logs.sort();
				wholeObject = object;
				//m.redraw(true);
			}

			const aa = require('aa');
			const findDirFiles = require('./find-dir-files');

			let timer;

			// 検索
			function search() {
				console.log('search ' + (timer != null));
				if (timer) return;
				console.log('search start!');
				logs = [];
				timer = setInterval(() => m.redraw(true), 20);
				aa(function *() {
					console.log('aa1');
					yield findDirFiles('..', text(), progressCallback);
					console.log('aa2');
					m.redraw(true);
					clearInterval(timer);
					timer = null; 
					console.log('search end');
				}).then(
					val => console.log('then val: ', val),
					err => console.log('then err: ', err)
				);
				return false;
			}
		}();
		</script>

<!--
		<pre><script>
		if (window.process)
			document.writeln('process.versions: ' + JSON.stringify(process.versions, null, '\t')),
			document.writeln('process.env: ' + JSON.stringify(process.env, null, '\t'));
		</script></pre>
-->

	</body>
</html>
