<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Search 検索</title>
		<style> body{ font-family: "メイリオ", Meiryo,
					"ＭＳ Ｐゴシック", "MS PGothic", sans-serif;
				font-size: 12px; line-height: 1.2; } </style>
		<script>if (window.module) delete module;</script>
		<script src="mithril.min.js" ></script>
	</head>
	<body>
		<div id="$div" />
		<script>
		void function () {
			'use strict';

			focus();

			const path = require('path');
			const aa = require('aa');
			const findDirFiles = require('./find-dir-files');

			const targetDir = process.env.AAA_TARGET_DIR;
			const text = m.prop('');
			let files = [];
			let filesIsDirty = false;
			let wholeObject = {};
			let timer;

			// view
			function view() {
				return [m('h3', 'Search 検索 - ',
							m('font[color=green]', targetDir)),
						m('form', {onsubmit: search},
						m('input', m_on('change', 'value', text,
							{autofocus: true, placeholder: '入力', size: 100})),
						m('button[type=submit]', {onclick: search}, '検索')),
					m('hr'),
					myViewResult(),
					m('hr')];
			}

			// 結果
			function myViewResult() {
				if (filesIsDirty) files = files.sort();
				else filesIsDirty = false;
				return files.filter(x => x.includes(text())).map(x => m('div', x));
			}

			// HTML要素のイベントと値にプロパティを接続するユーティリティ
			function m_on(eventName, propName, propFunc, attrs) {
				attrs = attrs || {};
				attrs['on' + eventName] = m.withAttr(propName, propFunc);
				attrs[propName] = propFunc();
				return attrs;
			}

			m.mount($div, {view});

			function progressCallback(file, object) {
				files.push(file);
				filesIsDirty = true;
				wholeObject = object;
			}

			// 検索
			function search() {
				if (timer) return;
				aa(function *() {
					files = [];
					timer = setInterval(() => m.redraw(true), 500);
					yield findDirFiles(targetDir, text(), progressCallback);
					m.redraw(true);
					clearInterval(timer);
					timer = null; 
				}).then(
					val => console.log('then val: ', val),
					err => console.log('then err: ', err)
				);
				return false;
			}
		}();
		</script>

		<pre><font color="brown"><script>
		if (window.process)
			document.writeln('process.cwd(): ' + process.cwd()),
			document.writeln('process.pid: ' + process.pid),
			document.writeln('process.versions: ' + JSON.stringify(process.versions, null, '\t')),
			document.writeln('process.env: ' + JSON.stringify(process.env, null, '\t'));
		</script></font></pre>

	</body>
</html>
