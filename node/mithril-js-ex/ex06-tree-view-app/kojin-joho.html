<!DOCTYPE html>
<html lang="ja">
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge, Chrome=1">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="Thu, 01 Dec 1994 16:00:00 GMT">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>kojin joho - Mithril.js</title>

<script src="/js/mithril.min.js"></script>
<script src="/js/mithril.ie.polyfill.min.js"></script>


<body>
<div id="$consoleElement"></div>
<div id="$kojinJohoElement"></div>
</body>

<script src="console-component.js"></script>

<script>

m.mount($consoleElement, m.component(consoleComponent, {limit: 10}));

// Date.now polyfill for IE8
if (!Date.now) Date.now = function now() { return new Date() - 0; };

// [].reduce polyfill for IE8
if (!Array.prototype.reduce)
	Array.prototype.reduce = function reduce(f) {
		var a = this[0];
		if (this.length <= 1) return a;
		for (var i = 1, n = this.length; i < n; ++i)
			a = f(this[i], a, i, this);
		return a;
	};

for (var i = 0; i < 10; ++i)
	console.log('');

var kojinJohoComponent = {
	controller: function (title, treeUrl, listUrl) {
		var ctrl = this;
		ctrl.title = title;
		ctrl.treeUrl = treeUrl;
		ctrl.listUrl = listUrl;
		ctrl.tree = m.request({method: 'GET', url: treeUrl + '?' + Date.now()});
		ctrl.list = m.request({method: 'GET', url: listUrl + '?' + Date.now()});
		ctrl.tree.then(function () {
			function getDepth(node, level) {
				if (!node || !node.children) return level;
				return node.children.map(function (child) {
					return getDepth(child, level + 1);
				}).reduce(function (a, b) { return a > b ? a : b; });
			}
			ctrl.depth = getDepth(ctrl.tree(), 1);
		});
		ctrl.deepView = function (node, list, level, indent, hide) {
			if (!node) return [];
			if (!level) level = 0;
			if (!indent) indent = '';
			var onclick = function () {
				node.hide = !node.hide;
				console.log('clicked: ' + node.name + ' ' + (node.hide ? 'off': 'ON!!!'));
			}
			return [
				m('tr', hide ? {style: {display: 'none'}} : {}, [
					indent,
					m('td',
							!node.children ? {colspan: ctrl.depth - level} :
							{colspan: ctrl.depth - level, onclick: onclick, ondblclick: onclick},
							node.name + (!node.children ? '' : node.hide ? '▼' : '△')),
					list.map(function (elem) {
						if (node.item) return m('td', elem[node.item] ? elem[node.item] : '-');
						else return m('td', '-');
					})
				]),
				!node.children ? '' :
				node.children.map(function (child) {
					return ctrl.deepView(child, list, level + 1, [m('td', '. . .'), indent], hide || node.hide);
				})
			];
		};
	},
	view: function (ctrl) {
		return [
			m('h1', {onclick: function () { ctrl.hide = !ctrl.hide; }},
					ctrl.title + (ctrl.hide ? '▼' : '△')),
			m('div', ctrl.hide ? {style: {display: 'none'}} : {}, [
				m('table', {border: 1, cellspacing: 1, cellpadding: 1, bgcolor: '#eeffff'}, [
					ctrl.deepView(ctrl.tree(), ctrl.list())
				]),
				'データ・ダウンロード: ',
				m('a', {href: ctrl.treeUrl}, ctrl.treeUrl), ', ',
				m('a', {href: ctrl.listUrl}, ctrl.listUrl)
			])
		];
	}
};

m.mount($kojinJohoElement, {
	controller: function () {
		this.comps = [
			m.component(kojinJohoComponent, '世帯情報1', 'setai-tree.json', 'setai-list.json'),
			m.component(kojinJohoComponent, '世帯情報2', 'setai-tree.json', 'setai-list.json')];
		this.ctrls = this.comps.map(function (comp) { return new comp.controller(); });
		this.views = this.comps.map(function (comp) { return comp.view; });
	},
	view: function (ctrl) {
		return ctrl.views.map(function (view, i) { return view(ctrl.ctrls[i]); });
	}
});

</script>

項目をクリックしてみてください。
