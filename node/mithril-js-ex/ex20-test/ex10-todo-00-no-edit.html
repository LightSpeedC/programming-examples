<!doctype html>
<meta charset="UTF-8">
<!--[if IE]><script src="../js/es5-shim.min.js"></script><![endif]-->
<script src="../js/mithril.min.js"></script>
<style>.todo-done { color: gray; text-decoration: line-through; }</style>
<script>
window.onload = function () {
	'use strict';

	var key = 0; // unique key

	var taskCompo = { // component: task
		controller: function (task) { return task; },
		view: function (task) {
			return m(task.done ? 'span.todo-done' : 'span', {},
				m('input[type=checkbox]', {checked: task.done,
					onclick: function () {task.done = !task.done;}}),
				task.title);
		}
	};

	function newTaskCompo(task) { // model:task and component
		return {task:task, compo:m('div', {key:++key}, m(taskCompo, task))};
	}

	var $input, input = ''; // input task
	var taskList = [{title: 'abc', done:false}, {title: 'xyz', done:true}].map(newTaskCompo);

	function todoAppView() { // todo application
		return [m('h3', 'やることリスト管理 (Mithril)'),
			m('input', {size: 60, autofocus: true, value: input,
				config: inConfig, onchange: inChange,
				placeholder: 'タスクを入力してください'}),
			m('button', {onclick: addClick}, '追加'),
			taskList.map(function (x) { return x.compo; }),
			m('div', 'チェックされているタスクを',
			m('button', {onclick: removeClick}, '削除'))];
	}

	function addClick() {
		if (!input) return;
		taskList.unshift(newTaskCompo({title:input, done:false}));
		input = '';
	}
	function inConfig(elem, isInit) {
		$input = elem;
		if (!isInit) elem.onkeypress = inKey;
	}
	function inKey(e) {
		if ((e || event).keyCode === 13) { inChange(); addClick(); m.redraw(); }
	}
	function inChange() { input = $input.value; }
	function removeClick() {
		taskList = taskList.filter(function (x) { return !x.task.done; });
	}

	m.mount(document.body, {view:todoAppView});
};
</script>
