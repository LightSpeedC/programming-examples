<!doctype html>
<meta charset="UTF-8">
<script src="../js/mithril.min.js"></script>
<!--[if IE]><script src="../js/es5-shim.min.js"></script><![endif]-->
<style>.todo-done { color: gray; text-decoration: line-through; }</style>
<body>
<h3>やることリスト管理 (Mithril)</h3>
<div id="$todoApp"></div>
</body>
<script>
void function () {
	'use strict';

	var key = 0; // unique key
	function dummy() {}

	var inputCompo = {
		controller: function (attrs) {
			var $input;
			this.attrs = attrs;
			this.inConfig = inConfig;
			this.inChange = inChange;
			this.inBlur = inBlur;
			var onchange = attrs.onchange || dummy;
			var onenter = attrs.onenter || dummy;
			var onblur = attrs.onblur || dummy;
			function inConfig(elem, isInit) {
				($input = elem).onkeypress = inKey;
			}
			function inKey(e) {
				if ((e || event).keyCode === 13) {
					onenter(e, attrs.value = $input.value);
					m.redraw(true); return false;
				}
			}
			function inBlur(e) {
				onblur(e, attrs.value = $input.value);
			}
			function inChange(e) {
				onchange(e, attrs.value = $input.value);
			}
		},
		view: function (ctrl) {
			var attrs = ctrl.attrs;
			return m('input', {size: 60, value: attrs.value, config: ctrl.inConfig,
				onchange: ctrl.inChange, onblur: ctrl.inBlur,
				autofocus: attrs.autofocus, placeholder: attrs.placeholder});
		}
	};

	// component: task
	var taskCompo = {
		controller: function (task) {
			var ctrl, inCtrl, inAttrs = {value: task.title,
				onchange: inChange, onblur: inChange, onenter: inChange};
			function inChange(e, value) {
				if (value) task.title = value;
				ctrl.editMode = false;
				inAttrs.value = task.title;
			}
			function inCompo() {
				if (!inCtrl) inCtrl = new (inputCompo.controller)(inAttrs);
				return (inputCompo.view)(inCtrl);
				//if (!inCtrl) inCtrl = m(inputCompo, inAttrs);
				//return inCtrl;
			}
			return ctrl = {task: task, editMode: false, inCompo: inCompo};
		},
		view: function (ctrl) {
			var task = ctrl.task;
			return m('div', {}, ctrl.editMode ? ctrl.inCompo() :
				m(task.done ? 'span.todo-done' : 'span',
					{ondblclick: function () { ctrl.editMode = true; }},
					m('input[type=checkbox]', {checked: task.done,
						onclick: function () {task.done = !task.done;}}),
						task.title));
		}
	};

	function newTaskCompo(x) {
		return {task:x, compo:m('div', {key:++key}, m(taskCompo, x))};
	}

	var todoApp = {
		controller: function (taskList) {
			var ctrl, inAttrs = {autofocus: true, value: '',
					onchange: inChange, onblur: inChange, onenter: addClick,
					placeholder: 'タスクを入力してください'};
			function addClick(e, value) {
				if (typeof value === 'string') inAttrs.value = value;
				if (!inAttrs.value) return;
				ctrl.taskList.unshift(newTaskCompo({title:inAttrs.value, done:false}));
				inAttrs.value = '';
			}
			function inChange(e, value) {
				if (typeof value === 'string') inAttrs.value = value;
			}
			function removeClick() {
				ctrl.taskList = ctrl.taskList.filter(function (x) { return !x.task.done; });
			}
			return ctrl = {taskList: !taskList ? [] : taskList.map(newTaskCompo),
				inAttrs: inAttrs, addClick: addClick, removeClick: removeClick};
		},
		view: function (ctrl) {
			return [
				m('div', {key:'input'}, m(inputCompo, ctrl.inAttrs),
					m('button', {onclick: ctrl.addClick}, '追加')),
				ctrl.taskList.map(function (x) { return x.compo; }),
				m('div', {key:'remove'}, 'チェックされているタスクを',
					m('button', {onclick: ctrl.removeClick}, '削除'))];
		}
	};

	m.mount($todoApp, m(todoApp, [{title: 'abc', done:false}, {title: 'xyz', done:true}]));
} ();
</script>
